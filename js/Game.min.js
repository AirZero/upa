function Nations(t){this.nationsSizeMultiplier=1,this.nations=[],this.phaserGame=t,this.onNationClick=null}function NationState(t){this.nationState=NATIONSTATE.states[0],this.maxRefugees=t,this.refugees=0}function NewsFeed(t,e,i,s,a,n,o){n=n||.5*lvlWidth,o=o||lvlHeight-.5*i,Phaser.Sprite.call(this,t,n,o,e),this.anchor.setTo(.5,.5),this.textStartingPoint=lvlWidth,this.textEndingPoint=0,this.width=lvlWidth,this.height=i,this.textTime=8,this.active=!0,this.fixedToCamera=!0,this.style=BASE_STYLE,s&&s.add(this),this.layerToAddTo=s,this.queue=[],this.shownTexts=[],this.margin=.25*lvlWidth,this.textGroup=this.game.add.group(),this.textGroup.z=a}function PlayerPrefs(){}function ProgressBar(t,e,i,s,a,n,o,r,h){Phaser.Sprite.call(this,s,t,e,i),this.x=this.x-.5*this.width,this.anchor.setTo(0,.5),this.wholeWidth=this.width,this.times=n;var u=a/n;this.repeatEvent=s.time.events.repeat(Phaser.Timer.SECOND*u,n,this.updateProgressBarsSize,this),this.method=o,this.timedEvent=s.time.events.add(Phaser.Timer.SECOND*a,function(){this.timeEnded()},this),h&&(this.background=s.add.sprite(t,e,h)),r&&(this.background&&r.add(this.background),r.add(this))}function RefugeeMonth(t,e,i,s){this.nationName=t,this.month=e,this.year=i,this.amount=s}function RefugeeProblem(t,e){this.name=t,this.deathToll=e}function RefugeeProblemHandler(t){this.problems=getJsonFromProblemData().problems,this.problemHandlers=[],this.game=t,this.numberAndPercentRegex=new RegExp("([0-9])+%")}function Refugees(t){this.game=t,this.totalRefugees=1e5,this.onRefugeeAmountChange=[],this.deaths=0,this.refugeeData=[]}function SpriteList(t,e,i,s,a,n,o,r,h){if(this.game=t,this.startX=e,this.endX=i,this.startY=s,this.endY=a,this.sprites=[],this.objects=n,this.sprite=o,this.layer=r,h)for(var u=0;u<this.objects;u++)this.addNewSprite()}function TextButton(t,e,i,s,a,n,o,r,h,u,l,p){h=h||1,u=u||0,l=l||2,p=p||3,this.button=t.add.button(0,0,i,this.perform,this,h,u,l,p),this.eventHandler=new EventHandler(s,r),this.active=!0,this.button.anchor.setTo(.5,.5),this.silencedObjects=[],this.text=t.add.text(0,0,e,a),this.text.anchor.setTo(.5,.5),n&&o&&this.setXandY(n,o)}function Dialog(t,e,i,s,a,n,o,r){a=a||.5*lvlWidth,n=n||.5*lvlHeight,o=o||.8*lvlWidth,r=r||.8*lvlHeight,this.background=t.add.sprite(0,0,"dialogBack"),this.background.anchor.setTo(.5,.5),this.background.x=a,this.background.y=n,this.background.width=o,this.background.height=r,this.background.fixedToCamera=!0;var h=this;this.silencedObjects=[];var u=.4*(r-n),l=.5*o*.8,p=n+.35*r;this.text=t.add.text(0,0,e,BASE_STYLE),this.text.anchor.setTo(.5,.5),this.text.x=a,this.text.y=n-.25*r,this.text.fixedToCamera=!0,this.background.inputEnabled=!0,this.background.input.priorityID=DIALOG_INPUTPRIORITY,this.buttons=[];for(var c=0;c<i.length;c++){var d=this.background.x-.5*l*(i.length-1),m=d+(i.length-1-c*i.length*.5)*o*.5*.8,g=i[c];this.buttons.push(this.createButton(t,s[c],"button",function(){g(),h.destroy()},BASE_STYLE,m,p,l,u))}}function EventHandler(t,e){this.method=t,this.callBackClass=e}function FeedText(t,e,i,s,a,n){Phaser.Text.call(this,t,e,i,s,a),this.fixedToCamera=!0,this.timesToShow=n||1}function Game(t){this.phaserGame=t,this.events=[],this.selectedNation=null,this.selectedTint=170393,this.maximumSelectedNations=5,this._selectedNations=0,this.selectedNationListener=null,this.mouseMover=new MouseMovement(t,CAMERA_MOVEMENT_SPEED),this.nations=new Nations(this.phaserGame);this.nations.addOnNationClickHandler(new EventHandler(this.onNationClick,this)),this.gameProgress=new GameProgress(this.phaserGame),this.gameEventHandler=new GameEventHandler(this.phaserGame),this.refugeeProblemHandler=new RefugeeProblemHandler(this.phaserGame),this.refugees=new Refugees(this.phaserGame),this.nextZ=0,this.moveOnMap=!0}function countDistance(t,e,i,s){return Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2))}function countIfInside(t,e,i){return t.x-.5*t.width<e&&e<t.x+.5*t.width&&t.y-.5*t.height<i&&i<t.y+.5*t.height?!0:!1}function GameDate(t,e,i){this.date=new Date(i,e-1,t),this.divider="."}function GameEventHandler(t){this.events=[],this.phaserGame=t,this.onEventProcess=[]}function GameProgress(t){this.phaserGame=t,this.monthInterval=8,this.dayInterval=this.monthInterval/30,this.startDate=new GameDate(5,3,2011),this.resetDate(),this.lastDayTime=this.phaserGame.time.totalElapsedSeconds(),this.onTimeChangedEvents=[],this.active=!0}function HumanParticle(t,e,i){Phaser.Particle.call(this,t,e,i,"hunam"),this.destination=null,this.tween=null,this.active=!0}function HumanParticleSystem(t,e,i,s,a,n){n=n||1,Phaser.Particles.Arcade.Emitter.call(this,t,0,0,a),this.particleClass=HumanParticle,this.z=n,this.makeParticles(),this.setRotation(0,0),this.emittedSprite=e,this.particleLifeSpan=i,this.gravity=0,this.busy=!1,this.active=!0,this.events=[],this.minParticleScale=.9,this.maxParticleScale=1,this.minParticleSpeed.x=0,this.minParticleSpeed.y=0,this.maxParticleSpeed.x=0,this.maxParticleSpeed.y=0,this.emitFrequency=s,this.xDestination=0,this.yDestination=0,this.forEach(this.initializeParticle,this,!1)}function HumanParticleSystemController(t,e,i,s,a,n){this.particleSystems=[];for(var o=0;e>o;o++){var r=new HumanParticleSystem(t,i,0,s,a/e,n[o]);this.particleSystems[this.particleSystems.length]=r}}function init(){var t=Phaser.AUTO;phaserGame=debugOn?new Phaser.Game(lvlWidth,lvlHeight,t,"",{preload:preload,create:create,update:update,render:render}):new Phaser.Game(lvlWidth,lvlHeight,t,"",{preload:preload,create:create,update:update})}function reset(){phaserGame.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,phaserGame.world.setBounds(0,0,lvlWidth,lvlHeight),phaserGame.camera.scale.x=1,phaserGame.camera.scale.y=1,phaserGame.stage.backgroundColor="#000000"}function preload(){if(debugOn){phaserGame.time.advancedTiming=!0;var t=phaserGame.renderType;alert(t===Phaser.CANVAS?"CanvasRenderer was used":t===Phaser.WEBGL?"WebGL was used":"HeadlessRenderer was used")}reset(),phaserGame.load.spritesheet("button",PICTURE_PATH+"buttonsWithUp.png",100,100),phaserGame.load.spritesheet("fullscreenButton",PICTURE_PATH+"fullscreenButtons.png",100,100),phaserGame.load.image("dialogBack",PICTURE_PATH+"dialogBack.png"),phaserGame.load.image("bar",PICTURE_PATH+"Bar.png"),phaserGame.load.spritesheet("shade",PICTURE_PATH+"Shade.png",200,200),phaserGame.load.image("textFeed",PICTURE_PATH+"TextFeed.png"),phaserGame.load.image("hunam",PICTURE_PATH+"HunamSmall.png"),phaserGame.load.image("infoLabel",PICTURE_PATH+"InfoLabel.png"),phaserGame.load.image("progress",PICTURE_PATH+"progress.png"),preloadGame(),preloadMenu()}function preloadGame(){game=new Game(phaserGame),game.preload()}function preloadMenu(){menu=new Menu(phaserGame,50,20,20)}function reMenu(){state="Menu",reset();var t=["Pelaa","Asetukset","Tiedot"],e=new Array;e[0]={method:function(){start()}},e[1]={method:function(){settings()}},e[2]={method:function(){info()}};var i=["button"];menu.create(t,e,i)}function create(){start()}function update(){"Game"===state&&game.update()}function info(){var t=["Ohjelmointi: Tero Paavolainen,","Eetu Rantakangas","Sisällöntuottaminen: Jarno Liski","Projektinjohtaja: Olli-Pekka Paajanen","Journalisti-tietotekniikko: Riikka Valtonen","Takaisin"],e=new Array;e[0]={method:function(){var t=new Dialog(phaserGame,"Siirrytäänkö Teron kotisivuille?",[function(){window.location.replace("http://users.jyu.fi/~tesatapa/")},function(){}],["Kyllä","Ei"]);t.silence(menu)}},e[1]={method:function(){}},e[2]={method:function(){}},e[3]={method:function(){}},e[4]={method:function(){}},e[5]={method:function(){reMenu()}},menu.create(t,e)}function settings(){var t=["Äänet","Näyttö","Modit","Takaisin"],e=new Array;e[0]={method:function(){}},e[1]={method:function(){screenSettings()}},e[2]={method:function(){var t=new Dialog(phaserGame,"Herp",[function(){}],["OK..."]);t.silence(menu)}},e[3]={method:function(){reMenu()}},menu.create(t,e)}function screenSettings(){var t=["Kokonäytön tila","Näytä maiden nimet "+(playerPrefs.getNumber("showNames")?"X":"_"),"Liikkuva kartta "+(playerPrefs.getNumber("moveMap")?"X":"_"),"Tuplaklikkaus päällä "+(playerPrefs.getNumber("doubleClickOn")?"X":"_"),"Takaisin"];xName=null;var e=new Array;e[0]={method:function(){phaserGame.scale.startFullScreen()}},e[1]={method:function(){playerPrefs.set("showNames",playerPrefs.getNumber("showNames")?0:1),screenSettings()}},e[2]={method:function(){playerPrefs.set("moveMap",playerPrefs.getNumber("moveMap")?0:1),screenSettings()}},e[3]={method:function(){playerPrefs.set("doubleClickOn",playerPrefs.getNumber("doubleClickOn")?0:1),screenSettings()}},e[4]={method:function(){settings()}},menu.create(t,e)}function render(){phaserGame.debug.pointer(phaserGame.input.activePointer),phaserGame.debug.text("FPS:"+phaserGame.time.fps,600,200)}function start(){menu.clear(),state="Game",game.start()}function Menu(t,e,i,s){this.titles=[],this.methods=[],this.pictures=[],this.game=t,this.textButtons=[],this.xMargin=e,this.yMargin=i,this.yMarginBetweenButtons=s,this.style=BASE_STYLE}function MouseMovement(t,e){this.phaserGame=t,this.cameraMovementSpeed=e,this.active=!0,this.pointerXMovement=null,this.pointerYMovement=null}function Nation(t,e,i,s,a,n){Phaser.Sprite.call(this,t,0,0,a),this.createText(t,s,e,i),this.inProcess=!1,this.name=s,this.active=!0,this.anchor.setTo(.5,.5),this.x=e,this.y=i,this.refugees=0,this.maxRefugees=n,this.nationState=new NationState(this.maxRefugees)}Nations.prototype.setActive=function(t){for(nationName in this.nations)this.nations[nationName].setActive(t)},Nations.prototype.preload=function(){this.preloadNationData()},Nations.prototype.getNationByName=function(t){return this.nations[t]},Nations.prototype.addOnNationClickHandler=function(t){this.onNationClick=t},Nations.prototype.increaseMaxRefugeeAmountsByData=function(t){for(dataQuery in t){var e=this.nations[t[dataQuery].name];e&&e.increaseMaxRefugeeAmount(t[dataQuery].amount)}},Nations.prototype.increaseMaxRefugeeAmounts=function(t){for(nationName in this.nations)this.nations[nationName].increaseMaxRefugeeAmount(t)},Nations.prototype.preloadNationData=function(){this.loadNationData()},Nations.prototype.loadNationData=function(){var t=getJsonFromNationsData();this.nationsData=t.nations,this.nationsSizeMultiplier=t.sizeMultiplier;for(var e=0;e<this.nationsData.length;e++)this.phaserGame.load.image(this.nationsData[e].sprite,PICTURE_PATH+"nations/"+this.nationsData[e].sprite+".png")},Nations.prototype.createNations=function(t,e){for(var i=0;i<this.nationsData.length;i++){var s=this.nationsData[i],a=JSON.parse(JSON.stringify(s));a.width=a.width*this.nationsSizeMultiplier,a.height=a.height*this.nationsSizeMultiplier;var n=this.parseNationX(a),o=this.parseNationY(a);this.createNation(t,e,n,o,a)}},Nations.prototype.createNation=function(t,e,i,s,a){this.textLayer=e;var n=new Nation(this.phaserGame,i,s,a.name,a.sprite,3500);n.setWidth(a.width),n.setHeight(a.height),n.angle=a.rotation,n.inputEnabled=!0,n.events.onInputDown.add(this.handleNationClick,this),n.setAutoCulling(!0),t.add(n),e.add(n.text),n.setTextVisibility(playerPrefs.getNumber("showNames")),this.nations[n.name]=n},Nations.prototype.handleNationClick=function(t){t.active&&this.onNationClick&&this.onNationClick.process(t)},Nations.prototype.parseNationSize=function(t,e,i){var s={width:0,height:0};return isNaN(e)?"x"===e.substr(e.length-2)&&(s.width=parseFloat(e.substr(0,e.length-2))*t.width):s.x=e,isNaN(i)?"x"===i.substr(i.length-2)&&(s.height=parseFloat(i.substr(0,i.length-2))*t.height):s.y=i,s},Nations.prototype.parseNationX=function(t){if(isNaN(t.x)){var e=t.x.split(","),i=e[0].split(":"),s=this.nations[i[1]],a={Percent:0,x:0};this.parseScripts(t,a,e,s);var n=0;return"Same"!==i[0]&&(n="Left"===i[0]?-1:1),a.x+=s?s.x+n*(.5*t.width+.5*s.width)+a.Percent*t.width:a.Percent*t.width,a.x}return t.x},Nations.prototype.parseNationY=function(t){if(isNaN(t.y)){var e=t.y.split(","),i=e[0].split(":"),s=this.nations[i[1]],a={Percent:0,x:0};this.parseScripts(t,a,e,s);var n=0;return"Same"!==i[0]&&(n="Up"===i[0]?-1:1),a.x+=s.y+n*(.5*t.height+.5*s.height)+a.Percent*t.height,a.x}return t.y},Nations.prototype.parseScripts=function(t,e,i){for(var s=1;s<i.length;s++){var a=i[s].split(":");switch(a[0]){case"Percent":var n=parseFloat(a[1]);e.Percent=.01*n;break;case"Add":e.x+=parseFloat(a[1]);break;case"Border":switch(a[1]){case"Right":e.x+=worldWidth-.5*t.width}}}},NationState.prototype.tintNormal=function(t){t.getInProcess()?this.tintSelected(t):this.tintOnState(t)},NationState.prototype.tintOnState=function(t){t.tint=this.nationState.tint},NationState.prototype.tintSelected=function(t){t.tint=170393},NationState.prototype.updateState=function(t,e,i){this.maxRefugees=t,this.refugees=e;var s=this.refugees/this.maxRefugees;s<.01*this.nationState.amount&&(this.nationState=NATIONSTATE.states[0]);for(stateName in NATIONSTATE.states){var a=NATIONSTATE.states[stateName];.01*a.amount<=s&&a.amount>this.nationState.amount&&(this.nationState=a)}this.tintNormal(i)},NewsFeed.prototype=Object.create(Phaser.Sprite.prototype),NewsFeed.prototype.constructor=NewsFeed,NewsFeed.prototype.setActive=function(t){this.active=t},NewsFeed.prototype.addText=function(t,e){e=e||3;var i=new FeedText(this.game,this.textStartingPoint,575,t,this.style,e);i.anchor.setTo(0,.5),this.queue.push(i)},NewsFeed.prototype.clearQueue=function(){this.queue=[];for(var t=0;t<this.shownTexts.length;t++)this.shownTexts[t].timesToShow=0},NewsFeed.prototype.destroy=function(){this.textGroup.destroy(),this.queue=[],this.shownTexts=[],Phaser.Sprite.prototype.destroy.call(this)},NewsFeed.prototype.setNextMessageToBeShown=function(){var t=this.queue[0];this.textGroup.add(t),this.shownTexts[this.shownTexts.length]=t,t.timesToShow--,this.resetForShow(t),this.queue.splice(0,1)},NewsFeed.prototype.resetForShow=function(t){t.cameraOffset.x=this.textStartingPoint},NewsFeed.prototype.update=function(){if(this.active){if(this.shownTexts.length<2&&this.queue.length>0)if(1==this.shownTexts.length){var t=this.shownTexts[0];t.cameraOffset.x+t.width<lvlWidth-this.margin&&this.setNextMessageToBeShown()}else this.setNextMessageToBeShown();for(var e=this.game.time.physicsElapsed,i=0;i<this.shownTexts.length;i++){var s=this.shownTexts[i];s.cameraOffset.x+=(this.textEndingPoint-this.textStartingPoint)*e/this.textTime,s.cameraOffset.x+s.width<=this.textEndingPoint&&(this.textGroup.remove(s,!1),this.shownTexts.splice(i,1),s.timesToShow>0&&this.queue.push(s))}}},NewsFeed.prototype.moveTexts=function(){},PlayerPrefs.prototype.get=function(t){var e=localStorage.getItem(t);return e},PlayerPrefs.prototype.getNumber=function(t){var e=this.get(t);return e=parseInt(e)},PlayerPrefs.prototype.set=function(t,e){localStorage.setItem(t,e)},ProgressBar.prototype=Object.create(Phaser.Sprite.prototype),ProgressBar.prototype.constructor=ProgressBar,ProgressBar.prototype.updateProgressBarsSize=function(){this.width-=this.wholeWidth/this.times},ProgressBar.prototype.timeEnded=function(){this.destroy(),this.method&&this.method()},ProgressBar.prototype.destroy=function(){Phaser.Sprite.prototype.destroy.call(this)},RefugeeProblemHandler.prototype.addProblemHandler=function(t,e){this.problemHandlers[this.problemHandlers.length]=new EventHandler(t,e)},RefugeeProblemHandler.prototype.clear=function(){this.problemHandlers=[]},RefugeeProblemHandler.prototype.dayChanged=function(t){for(problemName in this.problems){var e=this.problems[problemName];e.treshold<=t&&e.chance>=100*this.game.rnd.frac()&&this.invokeProblem(t,e)}},RefugeeProblemHandler.prototype.parseProblemData=function(t,e){var i;if(isNaN(t.deathToll))var s=t.deathToll;if(this.numberAndPercentRegex.test(s)){var a=.01*parseFloat(t.deathToll.substr(0,t.deathToll.length-1))*e;return i=new RefugeeProblem(t.name,a)}return i=new RefugeeProblem(t.name,t.deathToll)},RefugeeProblemHandler.prototype.invokeProblem=function(t,e){for(var i=this.parseProblemData(e,t),s=0;s<this.problemHandlers.length;s++)this.problemHandlers[s].process(i)},Refugees.prototype.addOnRefugeeAmountChange=function(t,e){this.onRefugeeAmountChange.push(new EventHandler(t,e))},Refugees.prototype.kill=function(t){this.deaths+=t,this.reduceTotalRefugees(t)},Refugees.prototype.clear=function(){this.onRefugeeAmountChange=[],this.totalRefugees=1e5},Refugees.prototype.changeTotalRefugees=function(t){this.totalRefugees+=t;for(handler in this.onRefugeeAmountChange)this.onRefugeeAmountChange[handler].process(t);return this.totalRefugees},Refugees.prototype.reduceTotalRefugees=function(t){if(t<=this.totalRefugees)return this.changeTotalRefugees(-t),0;var e=t-this.totalRefugees;return this.totalRefugees=0,e},Refugees.prototype.getTotalRefugees=function(){return this.totalRefugees},Refugees.prototype.preload=function(){this.game.load.text("refugeeDataCSV","assets/data/refugeeData.csv")},Refugees.prototype.parseData=function(){for(var t=this.game.cache.getText("refugeeDataCSV"),e=t.split(/\r\n|\r|\n/g),i=2010,s=0;s<e.length;s++)for(var a=e[s].split(","),n=1;n<a.length;n++)for(var o=a[n],r=o,h=1;12>=h;h++){var u=12!==h?Math.floor(.0833333333333333*o):r;r-=u,this.refugeeData.push(new RefugeeMonth(a[0],h,i+n-1,u))}},Refugees.prototype.start=function(){this.parseData()},Refugees.prototype.getAllRefugeesOfMonth=function(t,e){var i=[];for(dataName in this.refugeeData){var s=this.refugeeData[dataName];s.month===t&&s.year===e&&i.push({name:s.nationName,amount:s.amount})}return i},Refugees.prototype.getRefugees=function(t,e,i){return t.length*e*i*.01},SpriteList.prototype.clear=function(){this.removeAll(),this.sprites=[]},SpriteList.prototype.changeObjectAmount=function(t){for(;t>this.sprites.length;)this.addNewSprite();for(;t<this.sprites.length;)this.removeSprite()},SpriteList.prototype.removeAll=function(){for(;this.removeSprite(););},SpriteList.prototype.removeSprite=function(){return 0==this.sprites.length?!1:(this.sprites[this.sprites.length-1].destroy(),this.sprites.splice(this.sprites.length-1,1),!0)},SpriteList.prototype.addNewSprite=function(){if(this.objects<=this.sprites.length)return!1;var t=this.startX+(this.endX-this.startX)*this.sprites.length/this.objects,e=this.startY+(this.endY-this.startY)*this.sprites.length/this.objects,i=this.game.add.sprite(t,e,this.sprite);return i.anchor.setTo(.5,.5),i.fixedToCamera=!0,this.sprites[this.sprites.length]=i,this.layer&&this.layer.add(i),!0},TextButton.prototype.addToLayer=function(t){t.add(this.button),t.add(this.text)},TextButton.prototype.setFixedToCamera=function(t){this.button.fixedToCamera=t,this.text.fixedToCamera=t},TextButton.prototype.setInputPriority=function(t){this.button.input.priorityID=t},TextButton.prototype.silence=function(t){t.setActive(!1),this.silencedObjects[this.silencedObjects.length]=t},TextButton.prototype.perform=function(){this.active&&this.eventHandler.process()},TextButton.prototype.setVisible=function(t){this.setActive(t),this.button.visible=t,this.text.visible=t},TextButton.prototype.destroy=function(){this.active=!1,this.button.destroy(!0),this.text.destroy();for(var t=0;t<this.silencedObjects.length;t++)this.silencedObjects[t].setActive(!0);this.silencedObjects=[]},TextButton.prototype.setActive=function(t){this.active=t},TextButton.prototype.setWidth=function(t){this.button.width=t},TextButton.prototype.setHeight=function(t){this.button.height=t},TextButton.prototype.setText=function(t){this.text.text=t||this.text.text},TextButton.prototype.setXandY=function(t,e){this.button.x=t,this.button.y=e,this.text.x=t,this.text.y=e},Dialog.prototype.createButton=function(t,e,i,s,a,n,o,r,h){var u=new TextButton(t,e,"button",s,a,n,o);return u.setWidth(r),u.setFixedToCamera(!0),u.setHeight(h),u.setInputPriority(DIALOG_INPUTPRIORITY),u},Dialog.prototype.addToLayer=function(t){t.add(this.background);for(var e=0;e<this.buttons.length;e++)this.buttons[e].addToLayer(t);t.add(this.text)},Dialog.prototype.setTexts=function(t,e){this.text.text=t||this.text.text;for(var i=0;i<this.buttons.length;i++)this.buttons[i].setText(e[i])},Dialog.prototype.setActive=function(t){for(var e=0;e<this.buttons.length;e++)this.buttons[e].setActive(t)},Dialog.prototype.silence=function(t){t.setActive(!1),this.silencedObjects[this.silencedObjects.length]=t},Dialog.prototype.destroy=function(){this.background.destroy();for(var t=0;t<this.buttons.length;t++)this.buttons[t].destroy();this.text.destroy();for(var t=0;t<this.silencedObjects.length;t++)this.silencedObjects[t].setActive(!0);this.silencedObjects=[]},EventHandler.prototype.process=function(){this.callBackClass?this.method.call(this.callBackClass,arguments):this.method(arguments)},FeedText.prototype=Object.create(Phaser.Text.prototype),FeedText.prototype.constructor=FeedText;var CAMERA_MOVEMENT_SPEED=10;Object.defineProperty(Game.prototype,"selectedNations",{get:function(){return this._selectedNations},set:function(t){this._selectedNations=t,this.selectedNationListener&&this.selectedNationListener.process()}}),Game.prototype.preload=function(){this.nations.preload(),this.refugees.preload(),this.gameEventHandler.preload()},Game.prototype.createGroups=function(){this.BackgroundLayer=this.phaserGame.add.group(),this.BackgroundLayer.z=this.getNextAvailableZ(),this.GameLayer=this.phaserGame.add.group(),this.GameLayer.z=this.getNextAvailableZ(),this.particleLayerZs=[];for(var t=0;t<this.maximumSelectedNations;t++)this.particleLayerZs[this.particleLayerZs.length]=this.getNextAvailableZ();this.BarLayer=this.phaserGame.add.group(),this.BarLayer.z=this.getNextAvailableZ(),this.TextLayer=this.phaserGame.add.group(),this.TextLayer.z=this.getNextAvailableZ(),this.GUILayer=this.phaserGame.add.group(),this.GUILayer.z=this.getNextAvailableZ(),this.UpperGUILayer=this.phaserGame.add.group(),this.UpperGUILayer.z=this.getNextAvailableZ()},Game.prototype.getNextAvailableZ=function(){return this.nextZ++},Game.prototype.reMenu=function(){this.clear(),reMenu()},Game.prototype.clear=function(){this.GUILayer.destroy(!0),this.UpperGUILayer.destroy(!0),this.BackgroundLayer.destroy(!0),this.TextLayer.destroy(!0),this.GameLayer.destroy(!0),this.gameProgress.clear(),this.refugeeProblemHandler.clear(),this.refugees.clear(),this.gameEventHandler.clear(),this.humanParticleSystem.clear(),this.progressList.clear(),this.selectedNationListener=null;for(var t=0;t<this.events.length;t++)this.phaserGame.time.events.remove(this.events[t]);this.events=[],this._selectedNations=0},Game.prototype.start=function(){this.createGroups(),this.refugees.start(),this.moveOnMap=1===playerPrefs.getNumber("moveMap")?!0:!1,this.setWorld(),this.resetDate(),this.createLands(25),this.createGUI(),this.initializeParticleSystem(),this.addEvents(),this.updateRefugeeAmount(),this.mouseMover.moveCamera(.45*worldWidth,.33*worldHeight),this.waitForPlayer()},Game.prototype.waitForPlayer=function(){this.shadeButton=new TextButton(this.phaserGame,"Start by clicking the game","shade",this.tweenToCenter,BASE_STYLE,.5*lvlWidth,.5*lvlHeight,this,0,0,0,0);var t=this.nations.getNationByName("Syyria");t.tint=10027008,t.setActive(!1),this.shadeButton.setFixedToCamera(!0),this.shadeButton.setWidth(lvlWidth),this.shadeButton.setHeight(lvlHeight),this.shadeButton.addToLayer(this.UpperGUILayer),this.silenceGame(this.shadeButton),this.newsFeed.setActive(!0),this.newsFeed.addText("Voit aloittaa pelin klikkaamalla karttaa",999),this.newsFeed.addText("Maita klikkaamalla pakolaisia siirtyy kyseiseen maahan",999),this.newsFeed.addText("Syyriassa on alkanut vuosikymmenen pahin sisällissota.",100),this.newsFeed.addText("Kansainvälinen yhteisö on voimaton ja inhimillinen kärsimys lisääntyy.",100),this.newsFeed.addText("Ihmiset joutuvat jättämään kotinsa.",100),this.newsFeed.addText("Sinulle on annettu tehtäväksi auttaa pakolaisia löytämään oleskelupaikka Euroopasta.",100),this.newsFeed.addText("Toiset maat ovat vastaanottavaisempia kuin toiset.",100)},Game.prototype.tweenToCenter=function(){this.shadeButton.setActive(!1);var t=this.phaserGame.add.tween(this.phaserGame.camera).to({x:.38*worldWidth,y:.28*worldHeight});t.onComplete.addOnce(this.destroyShade,this),t.start()},Game.prototype.destroyShade=function(){this.shadeButton.destroy(),this.newsFeed.clearQueue()},Game.prototype.resetDate=function(){this.gameProgress.resetDate()},Game.prototype.createGUI=function(){var t=new TextButton(this.phaserGame,"Menu","button",this.reMenu,BASE_STYLE,.1*lvlWidth,.1*lvlHeight,this);t.setFixedToCamera(!0),t.addToLayer(this.UpperGUILayer);var e=.5*t.button.height,i=new Phaser.Button(this.phaserGame,t.button.x-.25*t.button.width,t.button.y+.5*t.button.height+e,"fullscreenButton",this.goFullScreen,this,1,0,2,3);i.fixedToCamera=!0,i.anchor.setTo(.5,.5),i.width=.5*t.button.width,i.height=e,this.UpperGUILayer.add(i);var s=.1*lvlHeight,a=this.phaserGame.add.sprite(0,lvlHeight-s,"infoLabel");a.anchor.setTo(0,1),a.fixedToCamera=!0,this.GUILayer.add(a),this.refugeeText=this.phaserGame.add.text(a.x+20,a.y-.3*a.height,"",NATION_TEXT_STYLE),this.updateRefugeeAmount(),this.refugeeText.fixedToCamera=!0,this.GUILayer.add(this.refugeeText),this.newsFeed=new NewsFeed(this.phaserGame,"textFeed",s,this.GUILayer,this.getNextAvailableZ()),this.progressList=new SpriteList(this.phaserGame,a.x+20,a.x+.5*a.width,a.y-.6*a.height,a.y-.6*a.height,5,"progress",this.GUILayer,!0),this.selectedNationListener=new EventHandler(this.updateProgressList,this),this.dateText=this.phaserGame.add.text(.5*lvlWidth,.1*lvlHeight,"Date:"+this.gameProgress.getDateString(),BASE_STYLE),this.dateText.anchor.setTo(.5,.5),this.dateText.fixedToCamera=!0,this.GUILayer.add(this.dateText)},Game.prototype.goFullScreen=function(){this.phaserGame.scale.startFullScreen()},Game.prototype.updateProgressList=function(){this.progressList.changeObjectAmount(this.maximumSelectedNations-this.selectedNations)},Game.prototype.initializeParticleSystem=function(){this.humanParticleSystem=new HumanParticleSystemController(this.phaserGame,this.maximumSelectedNations,"hunam",50,500,this.particleLayerZs);var t=this.nations.getNationByName("Syyria");this.humanParticleSystem.setOrigin(t.x,t.y)},Game.prototype.addEvents=function(){this.gameProgress.addOnTimeChangedEvent(this.gameEventHandler.checkForEventsOnTimeChange,this.gameEventHandler),this.gameProgress.addOnTimeChangedEvent(this.dayChangedForRefugeeProblemHandler,this),this.refugeeProblemHandler.addProblemHandler(this.handleNewProblem,this),this.gameProgress.addOnTimeChangedEvent(this.refreshDateText,this),this.gameEventHandler.addOnEventProcessingHandler(this.processGameEvent,this),this.refugees.addOnRefugeeAmountChange(this.updateRefugeeAmount,this)},Game.prototype.handleNewProblem=function(t){var e=t[0];this.newsFeed.addText(e.name+" has occurred with death toll of "+e.deathToll,1),this.refugees.kill(e.deathToll)},Game.prototype.dayChangedForRefugeeProblemHandler=function(){this.refugeeProblemHandler.dayChanged(this.refugees.getTotalRefugees())},Game.prototype.updateRefugeeAmount=function(){this.refugeeText.text="Refugees left: "+this.refugees.getTotalRefugees()},Game.prototype.processGameEvent=function(t){var e=t[0];for(effect in e.effects)this.completeEffect(e.effects[effect])},Game.prototype.completeEffect=function(t){switch(t.effectName){case"addRefugees":this.refugees.changeTotalRefugees(t.data);break;case"addMaxRefugees":this.increaseMaxRefugeeAmounts(t.data);break;case"endGame":this.endGame();break;case"story":this.addDialog(t.data);break;case"feed":this.addFeedData(t.data)}},Game.prototype.endGame=function(){this.createTimedEvent(2,this.reMenu)},Game.prototype.increaseMaxRefugeeAmounts=function(t){if(isNaN(t)){if("relative"===t){var e=this.refugees.getAllRefugeesOfMonth(this.gameProgress.getMonth(),this.gameProgress.getYear());this.nations.increaseMaxRefugeeAmountsByData(e)}}else this.nations.increaseMaxRefugeeAmounts(t)},Game.prototype.addFeedData=function(t,e){e=e||1,this.newsFeed.addText(t,e)},Game.prototype.silenceGame=function(t){t.silence(this.gameProgress),t.silence(this.newsFeed),t.silence(this.nations),t.silence(this.mouseMover),t.silence(this.humanParticleSystem)},Game.prototype.addDialog=function(t,e,i){e=e||function(){},i=i||"Ok";var s=new Dialog(this.phaserGame,t,[e],[i]);s.addToLayer(this.UpperGUILayer),this.silenceGame(s)},Game.prototype.refreshDateText=function(){this.dateText.text="Date:"+this.gameProgress.getDateString()},Game.prototype.nationSelectedForMoving=function(t){this.selectNation(null),this.startHousing(t)},Game.prototype.startHousing=function(t){if(!(t.getInProcess()||t.isFull()||this.selectedNations>=this.maximumSelectedNations)){t.setInProcess(!0),this.selectedNations++;var e=this.getRefugeeAmount(t),i=4;this.humanParticleSystem.send(void 0,void 0,t.x,t.y,.02*e,i,new EventHandler(function(){this.finishHousing(t,e)},this))}},Game.prototype.getRefugeeAmount=function(t){var e=Math.floor(.25*t.maxRefugees);return e},Game.prototype.finishHousing=function(t,e){this.selectedNations--,t.setInProcess(!1);var i=t.tryHousing(e);e-=i;var s=this.phaserGame.add.text(t.x,t.y,""+e,SMALL_STYLE),a=this.phaserGame.add.tween(s).to({x:s.x,y:s.y-.1*lvlHeight},500,Phaser.Easing.Linear.None,0);a.onComplete.addOnce(function(){s.destroy()}),a.start(),this.refugees.reduceTotalRefugees(e),this.refugees.getTotalRefugees()<0},Game.prototype.onNationClick=function(t){var e=t[0],i=this.phaserGame.input.activePointer;playerPrefs.getNumber("doubleClickOn")>0?i.msSinceLastClick<1e3*TIME_FOR_DOUBLECLICK&&this.selectedNation===e?this.nationSelectedForMoving(this.selectedNation):this.selectNation(e):this.nationSelectedForMoving(e)},Game.prototype.selectNation=function(t){this.selectedNation&&this.selectedNation.tintNormal(),null!==t&&t.tintNormal(),this.selectedNation=t},Game.prototype.clickStar=function(){this.GameLayer.forEach(function(t){{var e=this.phaserGame.input.activePointer;countIfInside(t,e.worldX,e.worldY)}})},Game.prototype.handleZoom=function(){this.zoom(this.phaserGame.input.mouse.wheelDelta)},Game.prototype.zoom=function(t){this.phaserGame.camera.scale.x<.5&&1>t||(this.phaserGame.camera.scale.x*=t,this.phaserGame.camera.scale.y*=t,this.phaserGame.world.setBounds(0,0,this.phaserGame.world.width*t,this.phaserGame.world.height*t))},Game.prototype.update=function(){this.moveOnMap&&this.mouseMover.update(),this.gameProgress.update();this.nations.getNationByName("Suomi");this.newsFeed.update()},Game.prototype.setWorld=function(){this.phaserGame.world.setBounds(0,0,worldWidth,worldHeight),this.phaserGame.stage.backgroundColor="#87CED0"},Game.prototype.returnToMenu=function(){this.clear(),reMenu()},Game.prototype.createTimedEvent=function(t,e){var i=this.phaserGame.time.events.add(Phaser.Timer.SECOND*t,e,this);this.events[this.events.length]=i},Game.prototype.createRepeatEvent=function(t,e,i){var s=this.phaserGame.time.events.repeat(Phaser.Timer.SECOND*t,e,i,this);this.events[this.events.length]=s},Game.prototype.createLands=function(){this.nations.createNations(this.GameLayer,this.TextLayer)},GameDate.prototype.progress=function(t,e,i){e=e||0,i=i||0,this.date.setDate(this.date.getDate()+t),this.date.setMonth(this.date.getMonth()+e),this.date.setFullYear(this.date.getFullYear()+i)},GameDate.prototype.progressYear=function(){this.progress(0,0,1)},GameDate.prototype.progressDay=function(){this.progress(1)},GameDate.prototype.progressMonth=function(){this.progress(0,1)},GameDate.prototype.getDay=function(){return this.date.getDate()},GameDate.prototype.getMonth=function(){return this.date.getMonth()+1},GameDate.prototype.getYear=function(){return this.date.getFullYear()},GameDate.prototype.getDateString=function(){var t=""+this.getDay(),e=""+this.getMonth(),i=(2==t.length?t:"0"+t)+this.divider+(2==e.length?e:"0"+e)+this.divider+this.getYear();return i},GameDate.prototype.getDate=function(){return null},GameEventHandler.prototype.addOnEventProcessingHandler=function(t,e){this.onEventProcess.push(new EventHandler(t,e))},GameEventHandler.prototype.clear=function(){this.onEventProcess=[]},GameEventHandler.prototype.preload=function(){var t=getJsonFromEventsData(),e=t.events;for(eventName in e)this.events.push(e[eventName])},GameEventHandler.prototype.checkForEventsOnTimeChange=function(t,e,i){this.checkForEventTick(t,e,i)
},GameEventHandler.prototype.checkForEventTick=function(t){var e=t[0],i=t[1],s=t[2];for(eventName in this.events){var a=this.events[eventName],n=a.date.split("."),o=this.parseIfNumber(n[0]),r=this.parseIfNumber(n[1]),h=this.parseIfNumber(n[2]);if(this.eventDateMatch(e,i,s,o,r,h)){var u=this.phaserGame.rnd.integerInRange(1,100);if(a.chance>=u)for(methodName in this.onEventProcess)this.onEventProcess[methodName].process(a)}}},GameEventHandler.prototype.parseIfNumber=function(t){return isNaN(t)?t:parseFloat(t)},GameEventHandler.prototype.eventDateMatch=function(t,e,i,s,a,n){return s!==t&&"x"!==s?!1:a!==e&&"x"!==a?!1:n!==i&&"x"!==n?!1:!0},GameProgress.prototype.clear=function(){this.onTimeChangedEvents=[]},GameProgress.prototype.resetDate=function(){this.date=new GameDate(this.startDate.getDay(),this.startDate.getMonth(),this.startDate.getYear())},GameProgress.prototype.addOnTimeChangedEvent=function(t,e){this.onTimeChangedEvents[this.onTimeChangedEvents.length]=new EventHandler(t,e)},GameProgress.prototype.setActive=function(t){this.active=t},GameProgress.prototype.getYear=function(){return this.date.getYear()},GameProgress.prototype.getMonth=function(){return this.date.getMonth()},GameProgress.prototype.getDateString=function(){return this.date.getDateString()},GameProgress.prototype.invokeListeners=function(){for(methodName in this.onTimeChangedEvents){var t=this.onTimeChangedEvents[methodName];t.process(this.date.getDay(),this.date.getMonth(),this.date.getYear())}},GameProgress.prototype.update=function(){if(this.active){var t=this.phaserGame.time.totalElapsedSeconds();t>this.lastDayTime+this.dayInterval&&(this.lastDayTime=t,this.date.progressDay(),this.invokeListeners())}},HumanParticle.prototype=Object.create(Phaser.Particle.prototype),HumanParticle.prototype.constructor=HumanParticle,HumanParticle.prototype.setActive=function(t){this.active=t,this.tween&&(this.tween.isPaused=!t)},HumanParticle.prototype.send=function(t){this.destination&&(this.tween=this.game.add.tween(this).to({x:this.destination.x,y:this.destination.y},t,Phaser.Easing.Linear.None,!0,0,0),this.tween.onComplete.addOnce(this.kill,this),this.tween.isPaused=!this.active)},HumanParticle.prototype.setDestination=function(t,e){null===this.destination&&(this.destination={x:t,y:e})},HumanParticle.prototype.destroy=function(){this.resetTweenAndDestination(),Phaser.Particle.prototype.destroy.call(this)},HumanParticle.prototype.resetTweenAndDestination=function(){this.tween&&this.tween.stop(),this.tween=null,this.destination=null},HumanParticle.prototype.kill=function(){this.resetTweenAndDestination(),Phaser.Particle.prototype.kill.call(this)},HumanParticleSystem.prototype=Object.create(Phaser.Particles.Arcade.Emitter.prototype),HumanParticleSystem.prototype.constructor=HumanParticleSystem,HumanParticleSystem.prototype.setActive=function(t){this.active=t,this.forEach(function(e){e.setActive(t)})},HumanParticleSystem.prototype.initializeParticle=function(t){var e=this;t.onEmit=function(){t.gravity=0,null===t.destination&&(t.z=this.z,t.setDestination(e.getXDestination(),e.getYDestination()),t.send(e.getTweenDuration()))}},HumanParticleSystem.prototype.getTweenDuration=function(){return this.tweenDuration},HumanParticleSystem.prototype.getXDestination=function(){return this.xDestination},HumanParticleSystem.prototype.getYDestination=function(){return this.yDestination},HumanParticleSystem.prototype.setOrigin=function(t,e){this.x=t,this.y=e},HumanParticleSystem.prototype.stop=function(){this.busy=!1;for(eventName in this.events)this.game.time.events.remove(this.events[eventName]);this.events=[]},HumanParticleSystem.prototype.destroy=function(){this.stop(),Phaser.Particles.Arcade.Emitter.prototype.destroy.call(this)},HumanParticleSystem.prototype.send=function(t,e,i,s,a,n,o){this.x=t||this.x,this.y=e||this.y,this.xDestination=i,this.yDestination=s;var r=this.game.time.events.add(Phaser.Timer.SECOND*n,function(){this.stop(),o.process()},this);this.events.push(r),n=1e3*n,n-=this.emitFrequency*a,this.tweenDuration=n,this._quantity=0,this.busy=!0,this.start(!1,0,this.emitFrequency,a)},HumanParticleSystemController.prototype.setActive=function(t){for(var e=0;e<this.particleSystems.length;e++)this.particleSystems[e].setActive(t)},HumanParticleSystemController.prototype.setOrigin=function(t,e){for(var i=0;i<this.particleSystems.length;i++)this.particleSystems[i].setOrigin(t,e)},HumanParticleSystemController.prototype.clear=function(){for(var t=0;t<this.particleSystems.length;t++)this.particleSystems[t].destroy();this.particleSystems=[]},HumanParticleSystemController.prototype.send=function(t,e,i,s,a,n,o){for(var r=0;r<this.particleSystems.length;r++)if(!this.particleSystems[r].busy)return this.particleSystems[r].send(t,e,i,s,a,n,o),!0;return!1};var lvlWidth=800,lvlHeight=600,worldWidth=1500,worldHeight=1500,TIME_FOR_DOUBLECLICK=.3,DIALOG_INPUTPRIORITY=2,BUTTON_INPUTPRIORITY=2,DATA_PATH="assets/data/",PICTURE_PATH="assets/pictures/",phaserGame,game,menu,BASE_STYLE={font:"32px Arial",fill:"#ff0044",align:"center"},SMALL_STYLE={font:"22px Arial",fill:"#aa1122",align:"center"},NATION_TEXT_STYLE={font:"26px Arial",fill:"#111111",align:"center"},state,playerPrefs=new PlayerPrefs;init(),Menu.prototype.setStyle=function(t){this.style=t},Menu.prototype.setActive=function(t){for(var e=0;e<this.textButtons.length;e++)this.textButtons[e].setActive(t)},Menu.prototype.create=function(t,e,i,s,a,n,o){if(this.pictures=i||this.pictures,this.game=s||this.game,this.xMargin=a||this.xMargin,this.yMargin=n||this.yMargin,this.yMarginBetweenButtons=o||this.yMarginBetweenButtons,!t||!e||t.length!=e.length)throw"There were issues with the given titles and methods!";this.titles=t,this.methods=e,this.createButtons()},Menu.prototype.clear=function(){if(0!=this.textButtons.length){for(var t=0;t<this.textButtons.length;t++)this.textButtons[t].destroy();this.textButtons=[]}},Menu.prototype.createButtons=function(){this.clear();var t=100;if(0==this.titles.length)throw"Titles can't be empty!";for(var e=lvlHeight>=2*this.yMargin+.5*t+this.titles.length*(t+this.yMarginBetweenButtons)?t:(lvlHeight-2*this.yMargin-this.titles.length*this.yMarginBetweenButtons)/this.titles.length,i=0;i<this.titles.length;i++){var s=this.style,a=this.game.world.centerX,n=this.yMargin+.5*e+i*(e+this.yMarginBetweenButtons),o=new TextButton(this.game,this.titles[i],this.pictures.length<=i?this.pictures[0]:this.pictures[i],this.methods[i].method,s,a,n);o.setWidth(lvlWidth-2*this.xMargin),o.setHeight(e),this.textButtons[this.textButtons.length]=o}},Menu.prototype.start=function(){this.createButtons()},MouseMovement.prototype.setActive=function(t){this.active=t},MouseMovement.prototype.update=function(){if(this.active){var t=this.phaserGame.input.activePointer;if(this.phaserGame.input.activePointer.isDown){if(!this.pointerXMovement)return this.pointerXMovement=t.x,void(this.pointerYMovement=t.y);var e=this.pointerXMovement-t.x,i=this.pointerYMovement-t.y,s=e/lvlWidth;s=2*s;var a=i/lvlHeight;a=2*a,this.moveCamera(s*this.cameraMovementSpeed,a*this.cameraMovementSpeed)}else this.pointerXMovement=null,this.pointerYMovement=null}},MouseMovement.prototype.moveCamera=function(t,e){this.phaserGame.camera.x+=t,this.phaserGame.camera.y+=e},MouseMovement.prototype.moveCameraTo=function(t,e){this.phaserGame.camera.x=t,this.phaserGame.camera.y=e},Nation.prototype=Object.create(Phaser.Sprite.prototype),Nation.prototype.constructor=Nation,Nation.prototype.setActive=function(t){this.active=t},Nation.prototype.increaseMaxRefugeeAmount=function(t){this.maxRefugees+=t,this.nationState.updateState(this.maxRefugees,this.refugees,this)},Nation.prototype.getInProcess=function(){return this.inProcess},Nation.prototype.setInProcess=function(t){this.inProcess=t,this.tintNormal()},Nation.prototype.setTextVisibility=function(t){this.text.visible=t},Nation.prototype.setAutoCulling=function(t){this.autoCull=t,this.text.autoCull=t},Nation.prototype.tintNormal=function(){this.nationState.tintNormal(this)},Nation.prototype.createText=function(t,e,i,s){this.text=t.add.text(0,0,e,NATION_TEXT_STYLE),this.text.anchor.setTo(.5,.5),this.text.x=i,this.text.y=s},Nation.prototype.destroy=function(){this.text.destroy(),Phaser.Sprite.prototype.destroy.call(this)},Nation.prototype.setXandY=function(t,e){this.x=t,this.y=e,this.text.x=t,this.text.y=e},Nation.prototype.setWidth=function(t){this.width=t},Nation.prototype.isFull=function(){return this.maxRefugees<=this.refugees},Nation.prototype.setHeight=function(t){this.height=t},Nation.prototype.tryHousing=function(t){var e=this.maxRefugees-this.refugees,i=0;return e>=t?this.refugees+=t:(i=t-e,this.refugees=this.maxRefugees),this.nationState.updateState(this.maxRefugees,this.refugees,this),i};